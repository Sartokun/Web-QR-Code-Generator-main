<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Admin · Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    :root{
      --bg:#0c0f15; --panel:#141a22; --panel-2:#10151c; --border:#2a3340;
      --text:#f1f6ff; --muted:#cbd5e6; --muted-2:#9db0c7;
      --c-uni:#78a8ff; --c-vis:#ff80a7; --c-dl:#ffc768; --c-up:#53e0d6;
      --accent:#ff85c0; --ring:rgba(255,133,192,.28);
    }
    html,body{min-height:100%}
    body{
      background:
        radial-gradient(1200px 800px at 85% -10%, rgba(255,133,192,.14), transparent 60%),
        radial-gradient(900px 700px at -10% 100%, rgba(120,168,255,.12), transparent 70%),
        var(--bg);
      color:var(--text);
      font-family:"Prompt", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .container-xxl{padding:28px 16px 44px; max-width:1180px}

    .nav-pills .nav-link{
      color:var(--text); border:1px solid var(--border);
      background:linear-gradient(180deg,var(--panel),var(--panel-2));
      margin-right:10px; border-radius:14px; padding:.5rem 1rem;
      transition:transform .15s ease, box-shadow .2s ease;
    }
    .nav-pills .nav-link:hover{transform:translateY(-1px); box-shadow:0 10px 26px rgba(255,133,192,.18)}
    .nav-pills .nav-link.active{color:#fff; border-color:transparent; background:linear-gradient(90deg,#fb87b0,#ec407a); box-shadow:0 12px 30px var(--ring)}

    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--border); border-radius:18px; box-shadow:0 16px 42px rgba(0,0,0,.35)}
    .lift:hover{transform:translateY(-2px); transition:.2s ease}

    .stat{display:flex; gap:14px; align-items:flex-start}
    .stat .ico{
      width:46px; height:46px; border-radius:14px; display:grid; place-items:center;
      color:#0d1117; font-size:1.25rem; font-weight:900; box-shadow:0 10px 18px rgba(0,0,0,.25)
    }
    .ico-uni{background:linear-gradient(135deg,#78a8ff,#9ec0ff)}
    .ico-vis{background:linear-gradient(135deg,#ff80a7,#ff9dbb)}
    .ico-dl{background:linear-gradient(135deg,#ffc768,#ffe3a0)}
    .ico-up{background:linear-gradient(135deg,#53e0d6,#8df1ea)}

    .lbl{color:var(--muted); font-weight:700; font-size:.98rem}
    .val{
      font-size:2.1rem; font-weight:800; line-height:1; margin-top:2px;
      background:linear-gradient(180deg,#ffbedc 0%,#ff5fa0 100%);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 8px 24px rgba(255,105,165,.25)
    }
    .today{color:var(--muted-2); font-size:.95rem}

    .chart-card{padding:18px 16px 10px}
    #chart{height:160px}

    .form-select,.form-control{background:#19202a; color:var(--text); border:1px solid var(--border)}
    .form-select:focus,.form-control:focus{box-shadow:0 0 0 .25rem var(--ring)}
    .btn-pink{background:linear-gradient(90deg,#fb87b0,#ec407a); color:#fff; border:none; box-shadow:0 12px 28px var(--ring)}

    .controls{display:flex; gap:.5rem; align-items:center; margin-bottom:16px}
    .controls .btn, .controls .form-select{border-radius:12px}

    .table-card{padding:0; border-radius:18px; overflow:hidden}
    .table-toolbar{display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#141a22,#10151c)}
    .table-title{font-weight:800; letter-spacing:.2px; color:#fff}
    .table-wrap{max-height:520px; overflow:auto; background:linear-gradient(180deg,var(--panel),var(--panel-2))}
    .table-wrap::-webkit-scrollbar{height:10px; width:10px}
    .table-wrap::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#2f3a4d,#222a37); border-radius:10px}
    .table-wrap::-webkit-scrollbar-track{background:#10141b}

    table.table{width:100%; border-collapse:separate; border-spacing:0; color:var(--text)}
    .table thead th{
      position:sticky; top:0; z-index:3; background:linear-gradient(180deg,#0f141c 0%,#0b1016 100%);
      border-bottom:1px solid var(--border); color:#e9f1ff; font-weight:800; letter-spacing:.2px; padding:12px 14px; user-select:none
    }
    .table thead th.sortable{cursor:pointer; transition:opacity .15s ease}
    .table thead th.sortable:hover{opacity:.85}
    .table tbody td{border-bottom:1px dashed rgba(255,255,255,.06); padding:12px 14px}
    .table tbody tr:nth-child(odd){background:rgba(255,255,255,.03)}
    .table tbody tr:hover{background:rgba(255,133,192,.08)}
    .num{text-align:right; font-variant-numeric:tabular-nums}
    .num.zero{color:var(--muted-2)}
    .num.unq{color:var(--c-uni); font-weight:800}
    .num.vis{color:var(--c-vis); font-weight:800}
    .num.dl{color:var(--c-dl); font-weight:800}
    .num.up{color:var(--c-up); font-weight:800}

    #metricsTable{
      --bs-table-bg:#0b1118; --bs-table-color:#eaf1ff;
      --bs-table-striped-bg:#0f1724; --bs-table-hover-bg:#151f2d; --bs-table-hover-color:#ffffff;
      --bs-border-color:rgba(255,255,255,.08); --bs-table-border-color:rgba(255,255,255,.08);
      background-color:var(--bs-table-bg)!important; color:var(--bs-table-color)!important;
    }
  </style>
</head>
<body>
  <div class="container-xxl">

    <!-- เมนูบน -->
    <ul class="nav nav-pills mb-3 gap-2">
      <li class="nav-item">
        <a href="{{ url_for('admin_dashboard') }}"
           class="nav-link {{ 'active' if request.endpoint == 'admin_dashboard' else '' }}">Dashboard</a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('admin_index') }}"
           class="nav-link {{ 'active' if request.endpoint in ['admin_index'] else '' }}">รายการไฟล์</a>
      </li>
    </ul>

    <!-- ฟิลเตอร์ -->
    <div class="controls">
      <select id="daysSel" class="form-select form-select-sm" style="width:110px">
        <option value="">เลือกช่วงวัน</option>
        <option value="7"  {{ 'selected' if days==7  else '' }}>7 วัน</option>
        <option value="14" {{ 'selected' if days==14 else '' }}>14 วัน</option>
        <option value="30" {{ 'selected' if days==30 else '' }}>30 วัน</option>
        <option value="60" {{ 'selected' if days==60 else '' }}>60 วัน</option>
      </select>

      <select id="yearSel" class="form-select form-select-sm" style="width:120px">
        <option value="">เลือกปี</option>
        {% for y in years %}
          <option value="{{ y }}" {{ 'selected' if year==y else '' }}>{{ y }}</option>
        {% endfor %}
      </select>

      <select id="monthSel" class="form-select form-select-sm" style="width:120px">
        <option value="">เลือกเดือน</option>
        {% set msel = month if month else None %}
        {% for m in range(1,13) %}
          <option value="{{ m }}" {{ 'selected' if msel==m else '' }}>{{ m }}</option>
        {% endfor %}
      </select>

      <button id="applyBtn" class="btn btn-pink btn-sm px-3">อัปเดต</button>
    </div>

    <!-- การ์ดสถิติ -->
    <div class="row g-3 mb-3">
      <div class="col-6 col-md-3">
        <div class="card p-3 lift">
          <div class="stat">
            <div class="ico ico-uni"><i class="bi bi-people"></i></div>
            <div>
              <div class="lbl">ผู้เยี่ยมชม (unique)</div>
              <div class="val">{{ totals.uniques }}</div>
              <div class="today">วันนี้: {{ totals.today.uniques }}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card p-3 lift">
          <div class="stat">
            <div class="ico ico-vis"><i class="bi bi-graph-up"></i></div>
            <div>
              <div class="lbl">เข้าชมทั้งหมด</div>
              <div class="val">{{ totals.visits }}</div>
              <div class="today">วันนี้: {{ totals.today.visits }}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card p-3 lift">
          <div class="stat">
            <div class="ico ico-dl"><i class="bi bi-download"></i></div>
            <div>
              <div class="lbl">ดาวน์โหลด</div>
              <div class="val">{{ totals.downloads }}</div>
              <div class="today">วันนี้: {{ totals.today.downloads }}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card p-3 lift">
          <div class="stat">
            <div class="ico ico-up"><i class="bi bi-upload"></i></div>
            <div>
              <div class="lbl">อัปโหลดไฟล์</div>
              <div class="val">{{ totals.uploads }}</div>
              <div class="today">วันนี้: {{ totals.today.uploads }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- กราฟ -->
    <div class="card chart-card mb-3">
      <canvas id="chart"></canvas>
    </div>

    <!-- ตารางรายวัน -->
    <div class="card table-card">
      <div class="table-toolbar">
        <div class="table-title">ตารางรายวัน</div>
        <div class="d-flex align-items-center gap-2">
          <label class="small text-secondary">เรียง</label>
          <select id="sortOrder" class="form-select form-select-sm">
            <option value="latest" selected>ใหม่ → เก่า</option>
            <option value="oldest">เก่า → ใหม่</option>
          </select>
        </div>
      </div>

      <div class="table-wrap">
        <table id="metricsTable" class="table table-sm align-middle">
          <thead>
            <tr>
              <th id="thDate" class="sortable">วันที่ (ICT)</th>
              <th class="num">ผู้เยี่ยมชม (unique)</th>
              <th class="num">เข้าชม</th>
              <th class="num">ดาวน์โหลด</th>
              <th class="num">อัปโหลด</th>
            </tr>
          </thead>
          <tbody>
            {% for i in range(series.labels|length) %}
            <tr>
              <td>{{ series.labels[i] }}</td>
              <td class="num" data-n>{{ series.uniques[i] }}</td>
              <td class="num" data-n>{{ series.visits[i] }}</td>
              <td class="num" data-n>{{ series.downloads[i] }}</td>
              <td class="num" data-n>{{ series.uploads[i] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- JSON ที่ server ฝังให้ -->
  <script id="metrics-json" type="application/json">{{ series | tojson }}</script>
  <script id="months-json"  type="application/json">{{ available_months | tojson }}</script>

  <script>
    (function () {
      // ===== 1) อ่าน JSON ที่ฝังมา =====
      const series = JSON.parse(document.getElementById('metrics-json').textContent || '{}');
      const availableMonths = JSON.parse(document.getElementById('months-json').textContent || '[]');

      // ===== 2) วาดกราฟ =====
      const ctx = document.getElementById('chart').getContext('2d');
      const getCss = k => getComputedStyle(document.documentElement).getPropertyValue(k).trim();
      const C = { uni:getCss('--c-uni'), vis:getCss('--c-vis'), dl:getCss('--c-dl'), up:getCss('--c-up') };
      const grad = (hex) => { const g = ctx.createLinearGradient(0,0,0,170); g.addColorStop(0,hex); g.addColorStop(1,'rgba(0,0,0,0)'); return g; };

      new Chart(ctx, {
        type:'line',
        data:{
          labels: series.labels || [],
          datasets:[
            { label:'ผู้เยี่ยมชม (unique)', data: series.uniques || [], borderColor:C.uni, backgroundColor:grad(C.uni), tension:.35, fill:true, pointRadius:0, borderWidth:2.6 },
            { label:'เข้าชม',               data: series.visits  || [], borderColor:C.vis, backgroundColor:grad(C.vis), tension:.35, fill:true, pointRadius:0, borderWidth:2.6 },
            { label:'ดาวน์โหลด',            data: series.downloads || [], borderColor:C.dl,  backgroundColor:grad(C.dl),  tension:.35, fill:true, pointRadius:0, borderWidth:2.6 },
            { label:'อัปโหลด',              data: series.uploads || [],   borderColor:C.up,  backgroundColor:grad(C.up),  tension:.35, fill:true, pointRadius:0, borderWidth:2.6 }
          ]
        },
        options:{
          maintainAspectRatio:false, responsive:true,
          interaction:{mode:'index', intersect:false},
          plugins:{legend:{position:'bottom', labels:{color:'#e8efff', font:{weight:'600'}}}},
          scales:{
            x:{grid:{color:'rgba(255,255,255,.07)'}, ticks:{color:'#dbe3f6', maxRotation:0, autoSkip:true}},
            y:{grid:{color:'rgba(255,255,255,.07)'}, ticks:{color:'#dbe3f6'}, beginAtZero:true}
          }
        }
      });

      // ===== 3) แต่งตาราง: คอมม่า + สีตัวเลข =====
      (function beautify() {
        document.querySelectorAll('#metricsTable tbody tr').forEach(tr => {
          const tds = tr.children;
          [[1,'unq'],[2,'vis'],[3,'dl'],[4,'up']].forEach(([i,cls])=>{
            const td = tds[i];
            const v = Number(td.textContent || 0);
            td.textContent = v.toLocaleString('th-TH');
            td.classList.add('num');
            if(v===0) td.classList.add('zero'); else td.classList.add(cls);
          });
        });
      })();

      // ===== 4) เรียงตามวันที่ =====
      (function sortByDate(){
        const tbody = document.querySelector('#metricsTable tbody');
        const select = document.getElementById('sortOrder');
        const thDate = document.getElementById('thDate');
        function sort(order){
          const rows = Array.from(tbody.rows);
          rows.sort((a,b)=>{
            const da = new Date(a.cells[0].textContent.trim());
            const db = new Date(b.cells[0].textContent.trim());
            return order==='latest' ? (db-da) : (da-db);
          });
          rows.forEach(r=>tbody.appendChild(r));
        }
        select.addEventListener('change',()=>sort(select.value));
        thDate.addEventListener('click',()=>{ select.value = select.value==='latest' ? 'oldest':'latest'; select.dispatchEvent(new Event('change')) });
        sort(select.value);
      })();

      // ===== 5) ฟอร์ม: days vs year+month =====
      const daysSel  = document.getElementById('daysSel');
      const yearSel  = document.getElementById('yearSel');
      const monthSel = document.getElementById('monthSel');

      function syncMonthsByYear(){
        const y = parseInt(yearSel.value || '0', 10);
        monthSel.innerHTML = '<option value="">เลือกเดือน</option>';
        if(!y){
          for(let m=1;m<=12;m++){ monthSel.insertAdjacentHTML('beforeend', `<option value="${m}">${m}</option>`); }
          return;
        }
        const ms = availableMonths.filter(x=>x.year===y).map(x=>x.month);
        const list = ms.length ? ms : Array.from({length:12},(_,i)=>i+1);
        list.forEach(m=> monthSel.insertAdjacentHTML('beforeend', `<option value="${m}">${m}</option>`));
      }
      yearSel.addEventListener('change', syncMonthsByYear);
      syncMonthsByYear();

      document.getElementById('applyBtn').addEventListener('click', () => {
        const y = yearSel.value.trim();
        const m = monthSel.value.trim();
        const d = daysSel.value.trim();
        let qs = '';
        if (y && m){ qs = `?year=${encodeURIComponent(y)}&month=${encodeURIComponent(m)}`; }
        else if (d){ qs = `?days=${encodeURIComponent(d)}`; }
        location.search = qs;
      });

    })();
  </script>
</body>
</html>
