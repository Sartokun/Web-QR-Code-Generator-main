<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>Admin · Files</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{ background:#121317; color:#e9eef5 }
    .card{ background:#191c22; border:1px solid rgba(255,255,255,.08) }
    .badge-soft{ background:rgba(255,255,255,.08); color:#cfd6e4 }
    .table thead th{ color:#9aa3b5; font-weight:700 }
    .thumb{ width:48px; height:48px; object-fit:cover; border-radius:8px; background:#0e1013 }
    .copy-btn{ border:1px solid rgba(255,255,255,.14) }
    .muted{ color:#9aa3b5 }
    a, a:visited{ color:#8dd0ff; text-decoration:none }
    a:hover{ text-decoration:underline }
    .sticky-top{ top:12px }
    .search { background:#121317; border:1px solid rgba(255,255,255,.12); color:#fff }
  </style>
</head>
<body class="py-3">
<div class="container-xxl">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">ไฟล์ทั้งหมด</h2>
    <div class="text-end">
      <div class="small muted">
        รวม: {{ totals.all }} ไฟล์ · ขนาดรวม {{ totals.size }} |
        โลโก้ {{ totals.logo }} · PDF {{ totals.pdf }} · MP3 {{ totals.mp3 }} · รูป {{ totals.image }}
      </div>
    </div>
  </div>

  <div class="card mb-3 sticky-top">
    <div class="card-body">
      <form method="get" class="row g-2">
        <input type="hidden" name="key" value="{{ admin_key }}">
        <div class="col-sm-8 col-md-6">
          <input class="form-control search" type="search" name="q" placeholder="ค้นหาชื่อไฟล์หรือประเภท (pdf/mp3/image/logo)">
        </div>
        <div class="col-sm-4 col-md-3">
          <button class="btn btn-primary w-100">ค้นหา</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
        <tr>
          <th style="width:56px;"></th>
          <th>ชื่อไฟล์</th>
          <th style="width:120px;">ประเภท</th>
          <th style="width:140px;">ขนาด</th>
          <th style="width:200px;">อัปเดต</th>
          <th style="width:340px;">ลิงก์</th>
          <th style="width:140px;"></th>
        </tr>
        </thead>
        <tbody>
        {% for r in rows %}
          <tr id="row-{{ r.kind }}-{{ r.atype or 'none' }}-{{ r.name|replace('.','_') }}">
            <td>
              {% if r.thumb and (r.atype == 'image' or r.kind == 'logo') %}
                <img class="thumb" src="{{ r.thumb }}" alt="thumb">
              {% else %}
                <div class="thumb d-flex align-items-center justify-content-center">–</div>
              {% endif %}
            </td>
            <td>
              <div class="fw-bold">{{ r.name }}</div>
              {% if r.atype %}<span class="badge rounded-pill badge-soft text-uppercase">{{ r.atype }}</span>{% endif %}
            </td>
            <td>{{ r.kind if r.kind!='asset' else r.atype }}</td>
            <td>{{ (r.size/1024/1024)|round(2) }} MB</td>
            <td><span class="muted">{{ r.mtime_iso }}</span></td>
            <td>
              <div class="d-flex flex-column gap-1">
                <div class="d-flex gap-2">
                  <a href="{{ r.url }}" target="_blank">เปิด</a>
                  <button class="btn btn-sm copy-btn" onclick="copy('{{ r.url }}')">คัดลอก</button>
                </div>
                <div class="small">
                  {% if r.short %}
                    <span class="muted">สั้น:</span> <a href="{{ r.short }}" target="_blank">{{ r.short }}</a>
                    <button class="btn btn-sm btn-outline-light ms-2" onclick="copy('{{ r.short }}')">คัดลอก</button>
                  {% else %}
                    <button class="btn btn-sm btn-outline-info" onclick="shorten('{{ r.url }}', this)">สร้างลิงก์สั้น</button>
                  {% endif %}
                </div>
              </div>
            </td>
            <td class="text-end">
              <form onsubmit="return del(this)" data-kind="{{ r.kind }}" data-atype="{{ r.atype or '' }}" data-name="{{ r.name }}">
                <input type="hidden" name="key" value="{{ admin_key }}">
                <button class="btn btn-sm btn-danger">ลบ</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
const ADMIN_KEY = "{{ admin_key }}";

function copy(txt){
  navigator.clipboard.writeText(txt).then(()=>alert("คัดลอกแล้ว")).catch(()=>{});
}

function shorten(longUrl, el){
  el.disabled = true; el.textContent = "กำลังสร้าง…";
  const fd = new FormData();
  fd.append("url", longUrl);
  fetch("/admin/shorten?key=" + encodeURIComponent(ADMIN_KEY), { method:"POST", body:fd })
    .then(r=>r.json()).then(d=>{
      if(!d.success) throw new Error(d.error||"fail");
      alert("สร้างลิงก์สั้นสำเร็จ: " + d.short_url);
      location.reload();
    }).catch(e=>{
      alert("ผิดพลาด: " + e.message);
      el.disabled = false; el.textContent = "สร้างลิงก์สั้น";
    });
  return false;
}

function del(form){
  if(!confirm("ลบไฟล์นี้ถาวร?")) return false;
  const fd = new FormData();
  fd.append("kind", form.dataset.kind);
  fd.append("atype", form.dataset.atype);
  fd.append("name", form.dataset.name);
  fetch("/admin/delete?key=" + encodeURIComponent(ADMIN_KEY), { method:"POST", body:fd })
    .then(r=>r.json()).then(d=>{
      if(!d.success) throw new Error(d.error||"fail");
      form.closest("tr").remove();
    }).catch(e=>alert("ลบไม่สำเร็จ: " + e.message));
  return false;
}
</script>
</body>
</html>
